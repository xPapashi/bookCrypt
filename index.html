<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel g≈Ç√≥wny ‚Äì Wizyty Klient√≥w</title>

    <!-- Font & Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 1rem;
        background: #f4f7fe;
        color: #333;
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        margin-bottom: 1rem;
        color: #5e5edd;
      }

      .filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .filters select {
        flex: 1;
        padding: 0.6rem;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 1rem;
        background: #fff;
        max-width: 200px;
      }

      .summary-cards {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .card {
        background: linear-gradient(135deg, #ffffff, #f0f4ff);
        border-radius: 20px;
        padding: 1rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: all 0.3s ease;
      }

      .card h2 {
        font-size: 1.2rem;
        margin: 0.25rem 0;
      }

      .card p {
        margin: 0;
        font-weight: bold;
        font-size: 1.4rem;
      }

      .chart-wrapper {
        padding: 1rem;
        background: #ffffff;
        border-radius: 20px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      canvas {
        width: 100% !important;
        max-height: 300px;
      }

      .btn-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 2rem;
      }

      .btn {
        background: #5e5edd;
        color: white;
        padding: 0.75rem;
        border: none;
        border-radius: 15px;
        font-size: 1rem;
        transition: 0.3s ease;
      }

      .btn:hover {
        background: #4e4ed9;
        cursor: pointer;
      }

      @media (min-width: 600px) {
        .summary-cards {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .card {
          flex: 1;
          min-width: 180px;
        }
      }
    </style>
  </head>

  <body>
    <h1>üìä Panel Wizyt Klient√≥w</h1>

    <div class="filters">
      <select id="monthFilter" onchange="renderSummary()"></select>
      <select id="yearFilter" onchange="renderSummary()"></select>
    </div>

    <div id="summary">
      <div class="summary-cards">
        <div class="card">
          <h2><i class="fas fa-users"></i> Obs≈Çu≈ºonych klient√≥w</h2>
          <p id="served"></p>
        </div>
        <div class="card">
          <h2><i class="fas fa-money-bill-wave"></i> Got√≥wka (miesiƒÖc)</h2>
          <p id="monthCash"></p>
        </div>
        <div class="card">
          <h2><i class="fas fa-credit-card"></i> Karta (miesiƒÖc)</h2>
          <p id="monthCard"></p>
        </div>
      </div>
      <div class="summary-cards">
        <div class="card">
          <h2><i class="fas fa-wallet"></i> Got√≥wka (rok)</h2>
          <p id="yearCash"></p>
        </div>
        <div class="card">
          <h2><i class="fas fa-credit-card-front"></i> Karta (rok)</h2>
          <p id="yearCard"></p>
        </div>
      </div>
    </div>

    <div class="chart-wrapper">
    <h3 style="text-align:center; margin-top:0">Struktura p≈Çatno≈õci ‚Äì wybrany miesiƒÖc</h3>
    <canvas id="monthChart"></canvas>
  </div>
  <div class="chart-wrapper">
    <h3 style="text-align:center; margin-top:0">Struktura p≈Çatno≈õci ‚Äì wybrany rok</h3>
    <canvas id="yearChart"></canvas>
  </div>

    <div class="btn-container">
      <button class="btn" onclick="location.href='addClient.html'">
        ‚ûï Dodaj wizytƒô
      </button>
      <button class="btn" onclick="location.href='clients.html'">
        üìã Zobacz klient√≥w
      </button>
      <button class="btn" onclick="location.href='settings.html'">‚öôÔ∏è Ustawienia</button>
      <button class="btn" onclick="logout()">üö™ Wyloguj</button>
    </div>

    <script>
      const encryptionKey = sessionStorage.getItem("key");
      if (!encryptionKey) location.href = "login.html";

      function decryptData(ciphertext) {
        try {
          const bytes = CryptoJS.AES.decrypt(ciphertext, encryptionKey);
          return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        } catch (e) {
          return null;
        }
      }

      let monthChartInstance = null;
      let yearChartInstance = null;

      function populateMonthYearFilters() {
        const monthFilter = document.getElementById("monthFilter");
        const yearFilter = document.getElementById("yearFilter");
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const months = [
          "Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
          "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"
        ];

        months.forEach((month, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = month;
          if (index === currentMonth) option.selected = true;
          monthFilter.appendChild(option);
        });

        for (let i = currentYear; i >= currentYear - 5; i--) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          if (i === currentYear) option.selected = true;
          yearFilter.appendChild(option);
        }
      }

      function renderSummary() {
        const visits = JSON.parse(localStorage.getItem("visits") || "[]");
        const selectedMonth = parseInt(document.getElementById("monthFilter").value);
        const selectedYear = parseInt(document.getElementById("yearFilter").value);

        let monthCash = 0, monthCard = 0, yearCash = 0, yearCard = 0, totalServed = 0;

        visits.forEach((cipher) => {
          const data = decryptData(cipher);
          if (data && data.paid) {
            const d = new Date(data.date);
            const amt = parseFloat(data.amount) || 0;

            if (d.getFullYear() === selectedYear) {
              if (data.payment === "gotowka") yearCash += amt;
              else if (data.payment === "karta") yearCard += amt;

              if (d.getMonth() === selectedMonth) {
                if (data.payment === "gotowka") monthCash += amt;
                else if (data.payment === "karta") monthCard += amt;
              }

              totalServed++;
            }
          }
        });

        document.getElementById("served").textContent = totalServed;
        document.getElementById("monthCash").textContent = `¬£${monthCash.toFixed(2)}`;
        document.getElementById("monthCard").textContent = `¬£${monthCard.toFixed(2)}`;
        document.getElementById("yearCash").textContent = `¬£${yearCash.toFixed(2)}`;
        document.getElementById("yearCard").textContent = `¬£${yearCard.toFixed(2)}`;

        renderCharts(monthCash, monthCard, yearCash, yearCard);
      }

      function renderCharts(monthCash, monthCard, yearCash, yearCard) {
        const monthCtx = document.getElementById("monthChart").getContext("2d");
        const yearCtx = document.getElementById("yearChart").getContext("2d");

        if (monthChartInstance) monthChartInstance.destroy();
        if (yearChartInstance) yearChartInstance.destroy();

        monthChartInstance = new Chart(monthCtx, {
          type: "pie",
          data: {
            labels: ["Got√≥wka", "Karta"],
            datasets: [{
              data: [monthCash, monthCard],
              backgroundColor: ["#4CAF50", "#2196F3"],
              hoverOffset: 4,
            }],
          },
          options: {
            plugins: {
              legend: { position: "bottom" },
              title: { display: false },
            },
            responsive: true,
            maintainAspectRatio: false,
          },
        });

        yearChartInstance = new Chart(yearCtx, {
          type: "pie",
          data: {
            labels: ["Got√≥wka", "Karta"],
            datasets: [{
              data: [yearCash, yearCard],
              backgroundColor: ["#FFC107", "#9C27B0"],
              hoverOffset: 4,
            }],
          },
          options: {
            plugins: {
              legend: { position: "bottom" },
              title: { display: false },
            },
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      }

      function logout() {
        sessionStorage.removeItem("key");
        location.href = "login.html";
      }

      populateMonthYearFilters();
      renderSummary();
    </script>
  </body>
</html>
