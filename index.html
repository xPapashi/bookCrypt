<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel gÅ‚Ã³wny â€“ Wizyty KlientÃ³w</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f4f7fe;
      color: #333;
      box-sizing: border-box;
      padding-bottom: 80px;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      color: #5e5edd;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .filters select {
      padding: 0.6rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      max-width: 200px;
    }

    .card-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin-bottom: 2rem;
    }

    .card {
      background: linear-gradient(135deg, #ffffff, #f0f4ff);
      border-radius: 20px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .card h2 {
      font-size: 1.1rem;
      margin: 0.5rem 0;
    }

    .card p {
      font-weight: bold;
      font-size: 1.5rem;
      margin: 0;
    }

    .chart-wrapper {
      padding: 1rem;
      background: #ffffff;
      border-radius: 20px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    canvas {
      width: 100% !important;
      max-height: 300px;
    }

    .summary-section {
      margin: 2rem 0;
      text-align: center;
    }

    .toggle-btn {
      background: linear-gradient(135deg, #a26ff3, #f559a9);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: linear-gradient(135deg, #8d5ee0, #dd4795);
    }

    .summary-cards {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
      padding: 0 1rem;
    }

    .summary-card {
      border-radius: 20px;
      padding: 1rem;
      color: white;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      text-align: center;
    }

    .summary-card h4 {
      margin: 0;
      font-size: 1.1rem;
    }

    .summary-card p {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0.5rem 0 0;
    }

    .summary-card.orange {
      background: linear-gradient(135deg, #ff9a44, #ff6363);
    }

    .summary-card.blue {
      background: linear-gradient(135deg, #42a5f5, #478ed1);
    }

    .summary-hidden {
      display: none;
    }

    /* Mobile Navigation */
    .mobile-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: linear-gradient(135deg, #eaeaff, #f5f5ff);
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .nav-item {
      flex: 1;
      text-align: center;
      color: #5e5edd;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      padding: 4px 0;
      font-weight: 500;
      text-decoration: none;
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 2px;
    }

    .nav-item.active,
    .nav-item:hover {
      background: #e3e3ff;
      border-radius: 10px;
      color: #4a4adb;
    }

    /* Desktop Navigation */
    .hamburger-nav {
      display: none;
    }

    @media(min-width: 768px) {
      .hamburger-nav {
        display: flex;
        gap: 1rem;
        justify-content: center;
        background: #f0f4ff;
        padding: 1rem;
        border-radius: 20px;
        margin-bottom: 2rem;
      }

      .hamburger-nav a {
        color: #5e5edd;
        font-weight: 600;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        transition: background 0.2s;
      }

      .hamburger-nav a:hover,
      .hamburger-nav a.active {
        background: #dddffe;
        color: #4a4adb;
      }

      .mobile-nav {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Panel Wizyt KlientÃ³w</h1>

  <div class="hamburger-nav">
    <a href="addClient.html" class="nav-link">Dodaj wizytÄ™</a>
    <a href="clients.html" class="nav-link">Klienci</a>
    <a href="settings.html" class="nav-link">Ustawienia</a>
    <a href="#" class="nav-link" onclick="logout()">Wyloguj</a>
  </div>

  <div class="filters">
    <select id="monthFilter" onchange="renderSummary()"></select>
    <select id="yearFilter" onchange="renderSummary()"></select>
  </div>

  <div class="card-grid">
    <div class="card"><h2>ðŸ‘¤ ObsÅ‚uÅ¼eni klienci</h2><p id="served">0</p></div>
    <div class="card"><h2>ðŸ’µ GotÃ³wka (miesiÄ…c)</h2><p id="monthCash">Â£0.00</p></div>
    <div class="card"><h2>ðŸ’³ Karta (miesiÄ…c)</h2><p id="monthCard">Â£0.00</p></div>
    <div class="card"><h2>ðŸ“… GotÃ³wka (rok)</h2><p id="yearCash">Â£0.00</p></div>
    <div class="card"><h2>ðŸ“† Karta (rok)</h2><p id="yearCard">Â£0.00</p></div>
  </div>

  <div class="summary-section">
    <button class="toggle-btn" onclick="toggleSummary()">ðŸ“Š Zobacz podsumowania</button>
    <div id="summaryContent" class="summary-hidden">
      <div class="summary-cards">
        <div class="summary-card orange">
          <h4>ðŸ’° MiesiÄ™cznie: Karta + GotÃ³wka</h4>
          <p id="monthTotal">Â£0.00</p>
        </div>
        <div class="summary-card blue">
          <h4>ðŸ“… Rocznie: Karta + GotÃ³wka</h4>
          <p id="yearTotal">Â£0.00</p>
        </div>
      </div>
    </div>
  </div>

  <div class="chart-wrapper">
    <h3 style="text-align:center;">Struktura pÅ‚atnoÅ›ci â€“ miesiÄ…c</h3>
    <canvas id="monthChart"></canvas>
  </div>

  <div class="chart-wrapper">
    <h3 style="text-align:center;">Struktura pÅ‚atnoÅ›ci â€“ rok</h3>
    <canvas id="yearChart"></canvas>
  </div>

  <nav class="mobile-nav">
    <a href="addClient.html" class="nav-item" id="nav-add">
      <i class="fas fa-plus-circle"></i>
      <span>Dodaj</span>
    </a>
    <a href="clients.html" class="nav-item" id="nav-clients">
      <i class="fas fa-users"></i>
      <span>Klienci</span>
    </a>
    <a href="settings.html" class="nav-item" id="nav-settings">
      <i class="fas fa-cog"></i>
      <span>Ustawienia</span>
    </a>
    <button class="nav-item" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span>Wyloguj</span>
    </button>
  </nav>

  <script>
    const encryptionKey = sessionStorage.getItem("key");
    if (!encryptionKey) location.href = "login.html";

    function decryptData(ciphertext) {
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, encryptionKey);
        return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
      } catch {
        return null;
      }
    }

    function logout() {
      sessionStorage.removeItem("key");
      location.href = "login.html";
    }

    function toggleSummary() {
      const box = document.getElementById("summaryContent");
      box.classList.toggle("summary-hidden");
    }

    function populateMonthYearFilters() {
      const monthFilter = document.getElementById("monthFilter");
      const yearFilter = document.getElementById("yearFilter");
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      const months = ["StyczeÅ„", "Luty", "Marzec", "KwiecieÅ„", "Maj", "Czerwiec", "Lipiec", "SierpieÅ„", "WrzesieÅ„", "PaÅºdziernik", "Listopad", "GrudzieÅ„"];

      months.forEach((month, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = month;
        if (index === currentMonth) option.selected = true;
        monthFilter.appendChild(option);
      });

      for (let i = currentYear; i >= currentYear - 5; i--) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        if (i === currentYear) option.selected = true;
        yearFilter.appendChild(option);
      }
    }

    function renderSummary() {
      const visits = JSON.parse(localStorage.getItem("visits") || "[]");
      const selectedMonth = parseInt(document.getElementById("monthFilter").value);
      const selectedYear = parseInt(document.getElementById("yearFilter").value);

      let monthCash = 0, monthCard = 0, yearCash = 0, yearCard = 0;
      const uniqueClients = new Set();

      visits.forEach(cipher => {
        const data = decryptData(cipher);
        if (data && data.paid) {
          const d = new Date(data.date);
          const amt = parseFloat(data.amount) || 0;

          if (d.getFullYear() === selectedYear) {
            if (data.payment === "gotowka") yearCash += amt;
            if (data.payment === "karta") yearCard += amt;

            if (d.getMonth() === selectedMonth) {
              if (data.payment === "gotowka") monthCash += amt;
              if (data.payment === "karta") monthCard += amt;
            }

            uniqueClients.add(data.name.trim().toLowerCase());
          }
        }
      });

      document.getElementById("served").textContent = uniqueClients.size;
      document.getElementById("monthCash").textContent = `Â£${monthCash.toFixed(2)}`;
      document.getElementById("monthCard").textContent = `Â£${monthCard.toFixed(2)}`;
      document.getElementById("yearCash").textContent = `Â£${yearCash.toFixed(2)}`;
      document.getElementById("yearCard").textContent = `Â£${yearCard.toFixed(2)}`;
      document.getElementById("monthTotal").textContent = `Â£${(monthCash + monthCard).toFixed(2)}`;
      document.getElementById("yearTotal").textContent = `Â£${(yearCash + yearCard).toFixed(2)}`;

      renderCharts(monthCash, monthCard, yearCash, yearCard);
    }

    function renderCharts(monthCash, monthCard, yearCash, yearCard) {
      const monthCtx = document.getElementById("monthChart").getContext("2d");
      const yearCtx = document.getElementById("yearChart").getContext("2d");

      if (window.monthChartInstance) window.monthChartInstance.destroy();
      if (window.yearChartInstance) window.yearChartInstance.destroy();

      window.monthChartInstance = new Chart(monthCtx, {
        type: "pie",
        data: {
          labels: ["GotÃ³wka", "Karta"],
          datasets: [{
            data: [monthCash, monthCard],
            backgroundColor: ["#4CAF50", "#2196F3"],
            hoverOffset: 4,
          }],
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });

      window.yearChartInstance = new Chart(yearCtx, {
        type: "pie",
        data: {
          labels: ["GotÃ³wka", "Karta"],
          datasets: [{
            data: [yearCash, yearCard],
            backgroundColor: ["#FFC107", "#9C27B0"],
            hoverOffset: 4,
          }],
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    function highlightActiveNav() {
      const current = window.location.pathname;
      const items = document.querySelectorAll(".nav-item, .nav-link");
      items.forEach(el => {
        if (el.href && current.includes(el.getAttribute("href"))) {
          el.classList.add("active");
        }
      });
    }

    populateMonthYearFilters();
    renderSummary();
    highlightActiveNav();
  </script>
</body>
</html>
